@using HandBook.Models.ViewModels;
@using Messenger.Models;
@using Microsoft.AspNetCore.Identity;
@inject UserManager<AppUser> UserManager
@model ExplorePageViewModel
<style>
    .user-link, .user-link:hover {
        text-decoration: none;
        color: black;
    }

    .user-information {
        background: white;
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        overflow-y: auto;
    }

    .container-explorer {
        position: relative;
        max-width: 90%; 
        margin: 20px auto; 
        padding: 20px;
    }


        #clearSearch:hover,
        #clearSearch:active,
        #clearSearch:focus {
            text-decoration: none; 
        }

</style>

<div class="container pt-5">
    <form id="searchForm" method="get">
        <div class="form-actions no-color">
            <div class="row justify-content-center position-relative">
                <input class="col-8 h5 pt-1 pb-1 m-0" type="text" placeholder="Search" name="SearchString" autocomplete="off" id="searchInput" value="@ViewData["CurrentFilter"]" />
                <div id="clearSearchMainClass" class="position-absolute pt-1  col-8 text-end">
                    <a href="#" id="clearSearch" class="btn-link col ">Cancel</a>
                </div>
                
            </div>
        </div>
    </form>

    <div id="explore-page" class="pt-2">
        <div class="row justify-content-center">
            <div class="col-8 p-0 m-0">
                @foreach (var item in Model.Posts)
                {
                    <div class="col-sm-6 col-md-4 col-lg-4">
                        <div class="explore-item">
                            @await Html.PartialAsync("~/Views/Home/_ExplorePagePartial.cshtml", item)
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

</div>

<div id="searchResults" style="z-index:1">
</div>

@section Scripts {
    <script src="@Url.Content("~/js/custom/explorePage.js")" type="text/javascript" asp-append-version="true"></script>
    <script src="@Url.Content("~/js/custom/postJs.js")" type="text/javascript" asp-append-version="true"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var searchInput = document.getElementById('searchInput');
            var explorePage = document.getElementById("explore-page");

            searchInput.addEventListener('input', function () {
                var searchString = searchInput.value;
                searchUsers(searchString);
            });

            searchInput.addEventListener("input", function () {
                if (searchInput.value.trim() !== "") {
                    explorePage.style.display = "none";
                } else {
                    explorePage.style.display = "block";
                }
            });
        });

        window.onload = function () {
            var searchInput = document.getElementById('searchInput');
            var searchStringBeggining = searchInput.value;
            searchUsers(searchStringBeggining);
        };

        function searchUsers(query) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var users = JSON.parse(xhr.responseText);
                        var resultsContainer = document.getElementById('searchResults');
                        resultsContainer.innerHTML = '';
                        users.forEach(function (user) {
                            var usernameLink = 'https://res.cloudinary.com/dzaicqbce/image/upload/v1695818842/profile-image-for-' + user.userName + '.png';
                            var alternativeLink = '/handbook/images/anonymousUser.png';
                            var imgTag = '<img src="' + usernameLink + '" alt="Image not found" onerror="this.onerror=null;this.src=\'' + alternativeLink + '\';" style="border-radius:30px;height:60px; width:60px; margin-right:10px;" />';

                            var userDiv = document.createElement('div');
                            userDiv.classList.add('container');
                            userDiv.innerHTML =
                                '<div class="row justify-content-center pt-1">' +
                                '   <div class="col-8 border">' +
                                '       <a class="user-link" href="/Home/Account?username=' + user.userName + '">' +
                                '           <div class="row align-items-center user-information">' +
                                '               <div class="col-1 pt-1 pb-1">' +
                                '                   ' + imgTag +
                                '               </div>' +
                                '               <div class="col">' +
                                '                   <div class="row p-0 m-0 h5">' +
                                '                       ' + user.userName +
                                '                   </div>' +
                                '               </div>' +
                                '           </div>' +
                                '       </a>' +
                                '   </div>' +
                                '</div>';

                            resultsContainer.appendChild(userDiv);
                        });
                    } else {

                    }
                }
            };

            if (query === "") {
                var resultsContainer = document.getElementById('searchResults');
                resultsContainer.innerHTML = '';
                return;
            }
            xhr.open('GET', '/Home/SearchUsersFilter?searchString=' + query, true);
            xhr.send();
        }

        document.getElementById('clearSearch').addEventListener('click', function (event) {
            event.preventDefault();
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHtml = '';
        });

    </script>
}